<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>News Search</title>
   <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <style>
       .markdown-content {
           @apply space-y-4;
       }
       .markdown-content ul {
           list-style: disc !important;
           padding-left: 2rem !important;
           margin-bottom: 1rem !important;
       }
       .markdown-content ul ul {
           list-style: circle !important;
           padding-left: 2rem !important;
       }
       .markdown-content ul ul ul {
           list-style: square !important;
       }
       .markdown-content li {
           display: list-item !important;
           list-style-position: outside !important;
           margin-bottom: 0.5rem !important;
       }
       .markdown-content li::marker {
           color: #4a5568;  /* Match text color */
           font-size: 1.1em;
       }
       .markdown-content h3 {
           @apply text-lg font-semibold mt-4 mb-2;
       }
       .markdown-content h2 {
           font-size: 1.25rem;
           font-weight: 600;
           margin-top: 1rem;
           margin-bottom: 0.5rem;
       }
       .markdown-content h4 {
           @apply font-medium text-gray-700 mt-4 mb-2 text-base;
       }
       /* Article layout container */
       .article-layout {
           display: grid;
           gap: 1.5rem;
           margin: 1rem 0;
       }

       /* Mobile-first: single column */
       @media (min-width: 1024px) {
           .article-layout {
               grid-template-columns: 3fr 2fr; /* 60% left, 40% right */
           }
       }

       /* Article main content */
       .article-main {
           background-color: white;
           border-radius: 0.5rem;
           padding: 1.25rem;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
       }

       /* Article sidebar */
       .article-insights {
           background-color: white;
           border-radius: 0.5rem;
           padding: 1.25rem;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
       }

       /* Sticky sidebar on desktop */
       @media (min-width: 1024px) {
           .article-insights {
               position: sticky;
               top: 1rem;
           }
       }

       /* Badge styles */
       .content-badge {
           display: inline-block;
           padding: 0.5rem 1rem;
           border-radius: 9999px;
           font-size: 0.875rem;
           font-weight: 500;
           margin-bottom: 1rem;
       }

       .badge-summary {
           background-color: #e0f2fe;
           color: #0369a1;
       }

       .badge-insights {
           background-color: #f3e8ff;
           color: #7e22ce;
       }

       /* Mobile safe area for pagination */
       @supports (padding-bottom: env(safe-area-inset-bottom)) {
           .pb-safe {
               padding-bottom: max(4rem, calc(1rem + env(safe-area-inset-bottom)));
           }
       }

       /* Fallback for browsers without safe-area-inset support */
       .pb-safe {
           padding-bottom: 4rem;
       }

       /* Ensure pagination buttons are touch-friendly on mobile */
       @media (max-width: 640px) {
           .pagination-container {
               position: sticky;
               bottom: 0;
               background: rgba(255, 255, 255, 0.95);
               backdrop-filter: blur(10px);
               border-top: 1px solid #e5e7eb;
               padding: 1rem;
               margin: 0 -1rem -1rem -1rem;
           }
       }
   </style>
</head>
<body class="bg-gray-50">
   <div class="container mx-auto p-4">
       <div class="flex justify-between items-center mb-6">
           <h1 class="text-2xl font-bold">News Search</h1>
           <a href="{{ url_for('main.index') }}" 
              class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
               Home
           </a>
       </div>

       <div class="mb-8 flex justify-between items-center">
           <form id="searchForm" method="GET" action="{{ url_for('news.search') }}" class="space-y-4 flex-grow">
               <div class="flex flex-col space-y-2">
                   <label for="q" class="text-gray-700 font-medium">Enter Stock Symbol or Keywords:</label>
                   <div class="flex space-x-4">
                       <input type="text" 
                              id="q" 
                              name="q" 
                              value="{{ search_params.q or search_params.symbol or search_params.keywords }}"
                              class="form-input rounded-md border-gray-300 shadow-sm w-full"
                              placeholder="AAPL or artificial intelligence or AAPL earnings">
                       <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                           Search
                       </button>
                       <a href="{{ url_for('news.search') }}" 
                          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                           New Search
                       </a>
                   </div>
               </div>
               

               
               <!-- Search examples helper -->
               <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                   <strong>Search Examples:</strong> 
                   <span class="font-mono">AAPL</span> (symbols), 
                   <span class="font-mono">artificial intelligence</span> (keywords), 
                   <span class="font-mono">china latest</span> (region), 
                   <span class="font-mono">highest sentiment</span> (sort), 
                   <span class="font-mono">lowest china</span> (sort + region)
               </div>
           </form>
       </div>

       <div id="resultsCount" class="text-lg text-gray-600 mb-4">
           {% if error %}
               <div class="text-red-500">Error: {{ error }}</div>
           {% elif articles %}
               {% if pagination and pagination.total > 0 %}
                   Article {{ pagination.page }} of {{ pagination.total }}
                   {% if region_info %}
                       <span class="text-blue-600 font-medium">üåç {{ region_info }}</span>
                   {% endif %}
                   {% if search_params.get('sort_order') == 'HIGHEST' %}
                       <span class="text-red-500 font-medium">üîù Highest Sentiment</span>
                   {% elif search_params.get('sort_order') == 'LOWEST' %}
                       <span class="text-orange-500 font-medium">üîª Lowest Sentiment</span>
                   {% endif %}
                   {% if search_params.get('has_latest') %}
                       <span class="text-purple-600 font-medium">üïê Last 3 Days</span>
                   {% endif %}
               {% else %}
                   No articles found for "{{ search_params.q or search_params.symbol or search_params.keywords }}"
                   {% if region_info %}
                       <span class="text-blue-600 font-medium">üåç {{ region_info }}</span>
                   {% endif %}
                   {% if search_params.get('sort_order') == 'HIGHEST' %}
                       <span class="text-red-500 font-medium">üîù Highest Sentiment</span>
                   {% elif search_params.get('sort_order') == 'LOWEST' %}
                       <span class="text-orange-500 font-medium">üîª Lowest Sentiment</span>
                   {% endif %}
                   {% if search_params.get('has_latest') %}
                       <span class="text-purple-600 font-medium">üïê Last 3 Days</span>
                   {% endif %}
                   {% if session.get('last_search_variants') %}
                   <div class="text-sm text-gray-500 mt-1">
                       (Searched for variants: {{ session.get('last_search_variants')|join(", ") }})
                   </div>
                   {% endif %}
               {% endif %}
           {% elif search_params.q or search_params.symbol or search_params.keywords %}
               No articles found for "{{ search_params.q or search_params.symbol or search_params.keywords }}"
               {% if region_info %}
                   <span class="text-blue-600 font-medium">üåç {{ region_info }}</span>
               {% endif %}
               {% if search_params.get('sort_order') == 'HIGHEST' %}
                   <span class="text-red-500 font-medium">üîù Highest Sentiment</span>
               {% elif search_params.get('sort_order') == 'LOWEST' %}
                   <span class="text-orange-500 font-medium">üîª Lowest Sentiment</span>
               {% endif %}
               {% if search_params.get('has_latest') %}
                   <span class="text-purple-600 font-medium">üïê Last 3 Days</span>
               {% endif %}
               {% if session.get('last_search_variants') %}
               <div class="text-sm text-gray-500 mt-1">
                   (Searched for variants: {{ session.get('last_search_variants')|join(", ") }})
               </div>
               {% endif %}
           {% endif %}
       </div>
       
       <!-- Top Pagination Controls -->
       {% if articles and pagination and pagination.pages > 1 %}
       <div class="flex justify-between items-center mb-6 py-3 px-4 bg-white border rounded-lg shadow-sm">
           <div class="flex space-x-2">
               {% if pagination.has_prev %}
               <a href="{{ url_for('news.search', page=pagination.prev_num, q=search_params.q, symbol=search_params.symbol, keywords=search_params.keywords) }}"
                  class="px-3 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                   ‚Üê Previous
               </a>
               {% else %}
               <span class="px-3 py-2 text-sm bg-gray-200 text-gray-400 rounded cursor-not-allowed">
                   ‚Üê Previous
               </span>
               {% endif %}
               
               {% if pagination.has_next %}
               <a href="{{ url_for('news.search', page=pagination.next_num, q=search_params.q, symbol=search_params.symbol, keywords=search_params.keywords) }}"
                  class="px-3 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                   Next ‚Üí
               </a>
               {% else %}
               <span class="px-3 py-2 text-sm bg-gray-200 text-gray-400 rounded cursor-not-allowed">
                   Next ‚Üí
               </span>
               {% endif %}
           </div>
           
           <div class="text-sm text-gray-600">
               Page {{ pagination.page }} of {{ pagination.pages }}
           </div>
       </div>
       {% endif %}

       <div id="articlesContainer" class="space-y-6">
           {% if articles %}
               {% for article in articles %}
               <div class="border-2 border-blue-100 rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow bg-white">
                   <!-- Article header -->
                   <a href="{{ article.url }}" target="_blank" 
                      class="block text-blue-500 text-xl font-semibold mb-3 hover:text-blue-600">
                       {{ article.title }}
                   </a>
                   
                   <div class="text-gray-500 mb-2">
                                               Published: {{ article.published_at if article.published_at else 'Unknown' }}
                       {% if article.symbols %}
                       <div class="mt-1">
                           Related Symbols: 
                           {% for symbol in article.symbols %}
                           <span class="bg-gray-100 px-2 py-1 rounded text-sm">
                               <a href="{{ url_for('news.search', symbol=symbol.symbol) }}" 
                                  class="text-blue-500 hover:text-blue-700">
                                   {{ symbol.symbol }}
                               </a>
                           </span>
                           {% endfor %}
                       </div>
                       {% endif %}
                   </div>

                   <!-- Two-column layout -->
                   <div class="article-layout">
                       <!-- Left column: Main content -->
                       <div class="article-main">


                           <!-- AI Summary (if available) -->
                           {% if article.summary and article.summary.ai_summary %}
                           <div class="mb-6">
                               <span class="content-badge badge-summary">AI Summary</span>
                               <div class="markdown-content">
                                   {{ article.summary.ai_summary|markdown|safe }}
                               </div>
                           </div>
                           {% endif %}

                           <!-- Original Content (if AI summary not available) -->
                           {% if not (article.summary and article.summary.ai_summary) and article.content %}
                           <div class="mb-6">
                               <span class="content-badge" style="background-color: #fef3c7; color: #92400e;">Original Content</span>
                               <div class="text-gray-700 leading-relaxed">
                                   {{ article.content[:500] }}{% if article.content|length > 500 %}...{% endif %}
                               </div>
                               {% if article.content|length > 500 %}
                               <a href="{{ article.url }}" target="_blank" class="text-blue-500 hover:text-blue-700 text-sm mt-2 inline-block">
                                   Read full article ‚Üí
                               </a>
                               {% endif %}
                           </div>
                           {% endif %}

                           <!-- Fallback when no content available -->
                           {% if not (article.summary and article.summary.ai_summary) and not article.content %}
                           <div class="mb-6">
                               <span class="content-badge" style="background-color: #fee2e2; color: #991b1b;">No Content Available</span>
                               <div class="text-gray-500 italic">
                                   Content not yet fetched. <a href="{{ article.url }}" target="_blank" class="text-blue-500 hover:text-blue-700">View original article ‚Üí</a>
                               </div>
                           </div>
                           {% endif %}

                           <!-- AI Sentiment Rating -->
                           {% if article.summary and article.summary.ai_sentiment_rating is not none %}
                           <div class="text-sm text-gray-500 mt-4 border-t pt-4">
                               <span class="px-4 py-2 mb-4 rounded-full text-sm font-medium 
                                   {% if article.summary.ai_sentiment_rating > 50 %}bg-green-100 text-green-800
                                   {% elif article.summary.ai_sentiment_rating < -50 %}bg-red-100 text-red-800
                                   {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                   AI Sentiment Rating: {{ article.summary.ai_sentiment_rating }}
                               </span>
                           </div>
                           {% endif %}
                       </div>

                       <!-- Right column: AI Insights -->
                       <div class="article-insights">
                           {% if article.summary and article.summary.ai_insights %}
                           <span class="content-badge badge-insights">AI Insights</span>
                           <div class="markdown-content">
                               {{ article.summary.ai_insights|markdown|safe }}
                           </div>
                           {% else %}
                           <!-- Show article metadata when AI insights not available -->
                           <span class="content-badge" style="background-color: #f0f9ff; color: #0369a1;">Article Info</span>
                           <div class="space-y-3 text-sm">
                               <div>
                                   <span class="font-medium text-gray-700">Source:</span>
                                   <span class="text-gray-600">{{ article.source or 'Unknown' }}</span>
                               </div>
                               {% if article.author %}
                               <div>
                                   <span class="font-medium text-gray-700">Author:</span>
                                   <span class="text-gray-600">{{ article.author }}</span>
                               </div>
                               {% endif %}
                               <div>
                                   <span class="font-medium text-gray-700">Published:</span>
                                   <span class="text-gray-600">{{ article.published_at if article.published_at else 'Unknown' }}</span>
                               </div>
                               {% if article.symbols %}
                               <div>
                                   <span class="font-medium text-gray-700">Related Symbols:</span>
                                   <div class="mt-1 flex flex-wrap gap-1">
                                       {% for symbol in article.symbols %}
                                       <a href="{{ url_for('news.search', symbol=symbol.symbol if symbol.symbol else symbol) }}" 
                                          class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200">
                                           {{ symbol.symbol if symbol.symbol else symbol }}
                                       </a>
                                       {% endfor %}
                                   </div>
                               </div>
                               {% endif %}
                               <div class="pt-2 border-t">
                                   <a href="{{ article.url }}" target="_blank" 
                                      class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                       Read Full Article ‚Üí
                                   </a>
                               </div>
                           </div>
                           {% endif %}
                       </div>
                   </div>
               </div>
               {% endfor %}

               {% if pagination and pagination.pages > 1 %}
               <div class="pagination-container flex justify-center space-x-1 sm:space-x-2 mt-8 mb-16 pb-safe">
                   {% if pagination.has_prev %}
                   <a href="{{ url_for('news.search', page=pagination.prev_num, q=search_params.q, symbol=search_params.symbol, keywords=search_params.keywords) }}"
                      class="px-2 py-2 sm:px-3 sm:py-2 text-sm border rounded hover:bg-gray-100 active:bg-gray-200 min-w-[44px] text-center">Prev</a>
                   {% endif %}

                   {% for page_num in pagination.iter_pages(left_edge=1, left_current=1, right_current=1, right_edge=1) %}
                       {% if page_num %}
                           {% if page_num == pagination.page %}
                           <span class="px-2 py-2 sm:px-3 sm:py-2 text-sm border rounded bg-blue-500 text-white min-w-[44px] text-center">
                               {{ page_num }}
                           </span>
                           {% else %}
                           <a href="{{ url_for('news.search', page=page_num, q=search_params.q, symbol=search_params.symbol, keywords=search_params.keywords) }}"
                              class="px-2 py-2 sm:px-3 sm:py-2 text-sm border rounded hover:bg-gray-100 active:bg-gray-200 min-w-[44px] text-center">
                               {{ page_num }}
                           </a>
                           {% endif %}
                       {% else %}
                           <span class="px-2 py-2 text-sm min-w-[44px] text-center">‚Ä¶</span>
                       {% endif %}
                   {% endfor %}

                   {% if pagination.has_next %}
                   <a href="{{ url_for('news.search', page=pagination.next_num, q=search_params.q, symbol=search_params.symbol, keywords=search_params.keywords) }}"
                      class="px-2 py-2 sm:px-3 sm:py-2 text-sm border rounded hover:bg-gray-100 active:bg-gray-200 min-w-[44px] text-center">Next</a>
                   {% endif %}
               </div>
               {% endif %}
           {% endif %}
       </div>
   </div>

   <script>
       function getSentimentClass(rating) {
           if (rating > 50) return 'bg-green-100 text-green-800';
           if (rating < -50) return 'bg-red-100 text-red-800';
           return 'bg-yellow-100 text-yellow-800';
       }
   </script>
</body>
</html>